function setText(e,t,n,i){if(i||(i=!1),t){var r,a,o=[],c=[],s=/\[[A-Za-z0-9]+\]/;e.x=i?e.x:0,e.lineWidth=i?e.lineWidth:800,e.text="",e.maxWidth=null;for(var l=[];;){var v=t.match(s);if(null==v)break;(v.g=v.index,l.push(v),0!=v.index||i)?t=t.replace(s,"　　　"):(e.x=260,e.lineWidth=540,t=t.replace(s,""))}for(var d=0;d<t.length;d++){for(var h in c.push(e.getMeasuredWidth()),"\n"==t.charAt(d)?(o.push(e.text),e.text=""):e.text=e.text+t.charAt(d),e.getMeasuredWidth()>e.lineWidth&&(e.text=e.text.slice(0,-1),o.push(e.text),e.text=t.charAt(d)),l)l[h].index==d&&(l[h].g=l[h].index,l[h].regY=o.length*e.lineHeight,l[h].line=o.length);if(o.length>=n||d==t.length-1){o.push(e.text),e.text="";for(h=0;h<o.length;h++)e.text=e.text+o[h]+"\n";if(o.length>n){r=e.text.slice(0,-3),e.text=r+"..",e.maxWidth=e.lineWidth;break}}}for(var m in l)l[m].regX=c[l[m].g+l[m].line]-48*(l[m].line+1),l[m].picW=144,l[m].picH=e.lineHeight;if(i&&(e.y=o.length>2?56:116),0!=l.length){var g=[];for(var u in l){var f,x,p=new createjs.Bitmap(images[l[u][0].slice(1,-1)]);switch(!0){case i:e.y=56,e.text="",f=260/p.image.width,x=200/p.image.height,a=f>x?x:f,p.x=e.x-p.image.width*a/2,p.y=f<x?(200-p.image.height*a)/2+e.y-10:e.y-10;break;case 0==l[u].index:f=240/p.image.width,x=240/p.image.height,a=f>x?x:f,p.x=(260-p.image.width*a)/2,p.y=(260-p.image.height*a)/2;break;default:f=l[u].picW/p.image.width,x=l[u].picH/p.image.height,a=f>x?x:f,p.x=e.x+l[u].regX+(l[u].picW-p.image.width*a)/2+48,p.y=e.y+l[u].regY+Math.abs(l[u].picH-p.image.height*a)/2}p.scaleX=a,p.scaleY=a,e.parent.addChild(p),g.push(p)}e.parent.tspAry=g}}}var setGameQuestion=function(e,t){function n(e){if(!f){f=!0;var t=m[0].opt?e.currentTarget:e.target;1===t.ans?(l+=1,h.ox.gotoAndPlay("showRight")):(v+=1,h.ox.gotoAndPlay("showError")),h.ox.visible=!0,i(),setTimeout(function(){m.shift(),h.ox.visible=!1,r()},2e3)}}function i(){h.a1.removeEventListener("click",n),h.a2.removeEventListener("click",n),h.a3.removeEventListener("click",n),h.rightBtn.removeEventListener("click",n),h.errorBtn.removeEventListener("click",n)}function r(){if(f=!1,0==m.length)return 2===e?(s.score=10*l,s.end=1):0===v?s.score=10:s.coin=-10,o(),void h.dispatchEvent(d);var t=!!m[0].opt;h.tit.gotoAndStop(t?1:0),h.rightBtn.visible=!t,h.errorBtn.visible=!t,h.a1.visible=t,h.a2.visible=t,h.a3.visible=t,h.btn1.visible=t,h.btn2.visible=t,h.btn3.visible=t;var i=h.no1;if(i.tspAry)for(var r in i.tspAry)i.removeChild(i.tspAry[r]);for(var a=1;a<=3;a++){var c=h["a"+a];if(c.tspAry)for(var r in c.tspAry)c.removeChild(c.tspAry[r])}if(!0===t)for(r=1;r<=3;r++){var g=h["btn"+r],x=h["a"+r],p=m[0].opt[r-1];g.addEventListener("click",n),g.ans=p[1]?1:null,x.tit.text=r,setText(x.txt,p[0],4,!0)}else h.rightBtn.ans=0===m[0].ans?1:0,h.errorBtn.ans=1===m[0].ans?1:0,h.rightBtn.addEventListener("click",n),h.errorBtn.addEventListener("click",n);setText(h.no1.txt,m[0].qus,4,!1),h.noTxt.text=2===e?"第"+(u-m.length+1)+"題 (共"+u+"題)":""}function a(e){var t=e.which||e.keyCode;32===t&&(m.shift(),i(),r())}function o(){removeEventListener("keydown",a),h.removeEventListener("gameEnd",c)}function c(){i(),o()}for(var s={score:0,coin:0},l=0,v=0,d=new CustomEvent("end",{detail:s}),h=new lib.oxGame,m=[],g=[],u=15,f=!1;m.length<(2===e?u:1);)0===g.length&&(g=g.concat(t)),m.push(g.splice(randomFix(g.length),1)[0]);return h.addEventListener("gameEnd",c),testQus&&(console.log("測驗模式 - 使用[空白鍵]快速切換題庫!"),addEventListener("keydown",a)),h.gotoAndStop(2===e?1:0),h.oxMc.visible=2!==e,h.ox.visible=!1,h.regX=h.x=480,h.regY=h.y=360,h.scale=0,r(),createjs.Tween.get(h).to({scale:1},250),h},setRandomEvent=function(e,t){function n(e){j||(j=!0,g=e.currentTarget,d.showTxt.visible=!1,a(g,1),setTimeout(function(){r(1)},500))}function i(e){switch(d.removeEventListener("gameEnd",s),d.removeEventListener("click",i),l.event=g.evt,g.evt){case u:case f:l.value=g.val;break;case L:case w:case T:l.coin=g.val}d.dispatchEvent(v)}function r(e){for(var t=0;t<=2;t++){var r=d["c"+t];switch(e){case 0:r.addEventListener("click",n),o(r,0);break;case 1:if(r.removeEventListener("click",n),0==r.currentFrame){a(r,1);var c=new createjs.Shape((new createjs.Graphics).f("#000").rr(-115,-150,230,300,15));c.alpha=.3,r.addChild(c)}setTimeout(function(){d.nextBtn.visible=!0,d.addEventListener("click",i)},500)}}}function a(e,t){createjs.Tween.get(e).to({scaleX:.1},150).call(function(){t?(e.gotoAndStop(1),c(e.titleTxt,e.tit),c(e.contentTxt,e.con,!0)):e.gotoAndStop(0)}).to({scaleX:1},150).call(function(){t||(e.cursor="point")})}function o(e,t){e.gotoAndStop(t),0!==t&&(c(e.titleTxt,e.tit),c(e.contentTxt,e.con,!0))}function c(e,t,n){if(t){var i="",r=0,a=0,o=0;e.maxWidth=e.lineWidth;for(var c=0;c<t.length;c++){var s=t.charAt(c),l=e.getMeasuredWidth();e.text=i+s,r=e.getMeasuredWidth()-a,r>e.lineWidth?(i=i+"\n"+s,a=l):i+=s}if(n){for(o=e.getMeasuredHeight()/e.lineHeight;o<3;)i="\n"+i,o++;e.text=i}}}function s(){d.removeEventListener("gameEnd",s);for(var e=0;e<=2;e++)mov=d["c"+e].removeEventListener("click",n);d.removeEventListener("click",i)}var l={score:0,coin:0,event:0,value:0},v=new CustomEvent("end",{detail:l}),d=0===e?new lib.chanceMc:new lib.destinyMc,h=[],m=[],g=null,u=0,f=1,x=2,p=3,k=4,E=5,b=6,L=7,w=8,T=9,y=1,A=0,B=[["前進%N格",y,u],["後退%N格",A,f],["小遊戲","來一場小遊戲放鬆一下吧!",x],["驗收站","總測驗!",p],["是非題","是是非非",k],["選擇題","到底哪一個是正確的呢?",E],["均富卡","你的錢也是我的錢",b],["發票中獎%N元",y,L],["領紅包%N元",y,w],["損失%N元",A,T]],_=["使用電腦時，坐姿良好。","不輕易在網路留下個人資料，避免被詐騙。","不沉迷網路，並常與家人去戶外活動。","課後複習上課的內容。","遵守網路分級制度，不瀏覽不當資訊網站。","遇到不會操作時，會主動詢問老師。"],F=["上課不專心","在電腦教室嬉鬧","回家不寫作業"],j=!1;for(d.addEventListener("gameEnd",s),0===e?h=[u,x,p,k,E,w]:(h=[u,f,L,T,b],t&&h.pop());m.length<3;){var W=h.splice(randomFix(h.length),1)[0],C=B[W],M=null;switch(_txt2=null,_r=0,mov=d["c"+m.length],C[2]){case u:_r=randomFix(3,1),M=C[0].replace("%N",_r),mov.val=_r;break;case f:_r=randomFix(3,1),M=C[0].replace("%N",_r),mov.val=-_r;break;case L:_r=100*randomFix(5,1),M=C[0].replace("%N",_r),mov.val=_r;break;case w:_r=10*randomFix(10,1),M=C[0].replace("%N",_r),mov.val=_r;break;case T:_r=50*randomFix(6,1),M=C[0].replace("%N",_r),mov.val=-_r;break;default:M=C[0]}switch(C[1]){case A:_txt2=F[randomFix(F.length)];break;case y:_txt2=_[randomFix(_.length)];break;default:_txt2=C[1]}mov.evt=C[2],mov.tit=M,mov.con=_txt2,m.push(W)}return d.nextBtn.visible=!1,d.showTxt.visible=!0,r(0),d},setGameEvent=function(e,t){function n(e){var t=(e/10).toFixed(1).toString();return-1===t.indexOf(".")&&(t+=".0"),t}function i(){function t(e){e.t=-1,m--,b.push(e.i)}function i(){if(--l<=0)return x(),s.timeTxt.text="0.0",v.visible=!1,s.help.gotoAndStop(1),s.help.visible=!0,s.help.scoreTxt.text=g,void s.help.okBtn.addEventListener("click",r);s.timeTxt.text=n(l),u();for(var e=1;e<=8;e++){var i=s["hole"+e],a=i.t-0;a>0?i.t=a-1:0===a&&(i.gotoAndPlay("g1"),t(i))}}function r(e){s.help.okBtn.removeEventListener("click",r),a.coin=g,s.dispatchEvent(o)}function c(e){var n=e.currentTarget;0==n.currentFrame||n.currentFrame>5||(n.gotoAndPlay("g2"),g+=10,t(n))}function u(e){if(!(!e&&100*Math.random()-(h-m)/h*10>10||h<=m+1)&&0!==b.length){var t=b.splice(randomFix(b.length),1)[0],n=s["hole"+(t-0+1)];n.gotoAndPlay(0),n.t=randomFix(30,30),m++}}function f(){s.help.startBtn.removeEventListener("click",f),s.help.visible=!1,createjs.Ticker.framerate=30,v.visible=!0,s.cursor="none",d=setInterval(i,100),u(1)}function x(){clearInterval(d),s.cursor="auto",createjs.Ticker.framerate=12,s.help.startBtn.removeEventListener("click",f),s.help.okBtn.removeEventListener("click",r);for(var e=1;e<=8;e++)s["hole"+e].removeEventListener("click",c);s.removeEventListener("mousedown",p),createjs.Ticker.removeEventListener("tick",k)}function p(){v.gotoAndPlay(1)}function k(){v.x=e.mouseX,v.y=e.mouseY}function E(){s.removeEventListener("gameEnd",E),x()}var b=[];s.addEventListener("gameEnd",E),h=8,m=0,l=100;for(var L=1;L<=8;L++){var w=s["hole"+L];w.gotoAndStop(0),w.i=L-1,w.hitArea=w._hit,w.addEventListener("click",c),b.push(w.i)}s.addEventListener("mousedown",p),s.help.startBtn.addEventListener("click",f),createjs.Ticker.addEventListener("tick",k)}function r(){function t(){for(var e in s.help.okBtn.removeEventListener("click",t),E)s.mc.removeChild(E[e]);a.coin=g,createjs.Ticker.framerate=12,s.dispatchEvent(o)}function i(){s.help.visible=!0,s.help.scoreTxt.text=g,s.help.okBtn.addEventListener("click",t)}function r(){if(--l<=0)return s.timeTxt.text="0.0",s.help.gotoAndStop(1),i(),void x();s.timeTxt.text=n(l)}function c(){u();var t=e.mouseX;switch(!0){case t>890:t=890;break;case t<70:t=70}for(var n in v.x=t,v.y=600,E)if(E[n]){var r=E[n],a=r.globalToLocal(v.x,v.y);if(v.hitTest(a.x,a.y))switch(r.evt){case-1:return s.mc.removeChild(r),v.gotoAndPlay("boom"),s.help.gotoAndStop(2),x(),void i();default:g+=r.evt-0,s.mc.removeChild(r),E[n]=null,m--}else r.y>720?(s.mc.removeChild(r),E[n]=null,m--):l/k>.8?(r.y+=1*r.wig,createjs.Ticker.framerate=20):l/k>.6?(r.y+=1.1*r.wig,createjs.Ticker.framerate=24):l/k>.3?(r.y+=1.2*r.wig,createjs.Ticker.framerate=28):(r.y+=1.4*r.wig,createjs.Ticker.framerate=32)}}function u(e){if(!(!e&&h<=m+1||randomFix(100)-20*(h-m)/h-(k-l)/10>10)){var t=new lib.coinMc,n=randomFix(b[b.length-1]);for(var i in m+=1,b)if(b[i]>n){t.gotoAndStop(i),t.wig=b[i],t.evt=L[i];break}t.scaleX=t.scaleY=1.4,t.cache(-40,-40,80,80),t.x=randomFix(780,100),t.y=0,E.push(t),s.mc.addChild(t)}}function f(){s.help.startBtn.removeEventListener("click",f),createjs.Ticker.addEventListener("tick",c),s.help.visible=!1,createjs.Ticker.framerate=20,v.visible=!0,s.cursor="none",d=setInterval(r,100),u(1)}function x(){clearInterval(d),s.cursor="auto",s.help.startBtn.removeEventListener("click",f),createjs.Ticker.removeEventListener("tick",c)}function p(){createjs.Ticker.framerate=12,s.removeEventListener("gameEnd",p),x()}var k,E=[],b=[6,10,12,13],L=[1,2,5,-1];s.addEventListener("gameEnd",p),l=k=200,h=12,m=0,s.timeTxt.text=n(l),s.help.startBtn.addEventListener("click",f)}var a={score:0,coin:0},o=new CustomEvent("end",{detail:a}),c=void 0!==t?t:randomFix(2),s=0===c?new lib.game1Mc:new lib.game2Mc,l=0,v=s.car,d=null,h=0,m=0,g=0;switch(s.help.gotoAndStop(0),v.mouseEnabled=!1,v.visible=!1,c){case 0:i();break;case 1:r()}return s};